/*!
|''Name''|notabene|
|''Version''|0.7.5|
|''License''|BSD (http://en.wikipedia.org/wiki/BSD_licenses)|
|''Source''|https://github.com/jdlrobson/notabene/blob/master/src/notabene.js|
!*/
var APP_PATH="/takenote";var RESERVED_TITLES=["takenote","dashboard","takenote_manifest.appcache","notabene.css","jquery-ui.min.js","jquery-json.min.js"];var RECENT_STORAGE_ID="takenote-recent";var config;var firstTime=true;if(window.navigator.standalone){$("#backstage a").click(function(a){window.location.href=$(a.target).attr("href");a.preventDefault();return false})}var notabene={defaultFields:{},loadConfig:function(){config=localStorage.getItem("_takeNoteConfig")?JSON.parse(localStorage.getItem("_takeNoteConfig")):{};if(config.noGeoTiddlers){if(new Date().getTime()-config.noGeoTiddlers>1000*60*60*24){notabene.saveConfig("noGeoTiddlers",false)}}},saveConfig:function(a,b){if(typeof(a)!="undefined"&&typeof(b)!="undefined"){config[a]=b}localStorage.setItem("_takeNoteConfig",JSON.stringify(config))},watchPosition:function(a){if(!!navigator.geolocation&&!config.noGeoTiddlers){navigator.geolocation.watchPosition(a,function(){notabene.saveConfig("noGeoTiddlers",new Date().getTime())})}},supports_local_storage:function(){try{return"localStorage" in window&&window.localStorage!==null}catch(a){return false}},clearRecentChanges:function(){localStorage.removeItem(RECENT_STORAGE_ID)},getRecentChanges:function(){var a=localStorage.getItem(RECENT_STORAGE_ID);a=a?$.parseJSON(a):[];return a},addRecentChange:function(d,e){var c=notabene.getRecentChanges();var f=[];for(var b=0;b<c.length;b++){var a=c[b];a=typeof(a)==="string"?{title:a}:a;if(a.title!==e){f.push(a)}}f.push({title:e,bag:d});f=f.length>5?f.slice(f.length-5):f;localStorage.setItem(RECENT_STORAGE_ID,$.toJSON(f))}};notabene.loadConfig();function autoResize(c,b){b=b||{};var a=function(g){c=g.target;var k=$("<div />").addClass($(c).attr("class")).hide().css({"word-wrap":"break-word"}).insertBefore($(c)[0]);var j=$(c).val()||"";var d=j.split("\n");for(var e=0;e<d.length;e++){$("<span />").text(d[e]).appendTo(k);$("<br />").appendTo(k)}var f=$(k).height();if(b.minHeight&&f<b.minHeight){f=b.minHeight}if(b.buffer){f+=b.buffer}$(g.target).height(f);$(k).remove()};$(c).focus(a).keyup(a).blur(a);$(c).focus()}function setup_store(b){b=b||{};var e=b.bag;var d=b.host;var c=new tiddlyweb.Bag(e,d);var a=new tiddlyweb.Store();a.retrieveCached();return{store:a,bag:c,host:d}}function init(a,b,d){if(localStorage.getItem("DEFAULT_SPACE")){b.space=localStorage.getItem("DEFAULT_SPACE");b.bag=b.space+"_public";d(b)}else{if(!b.bag&&!b.space){var c=new tiddlyweb.Store();c.getDefaults(function(f){var e=f.pushTo.name;b.space=e&&e.split("_").length==2?e.split("_")[0]:"frontpage";b.bag=e;localStorage.setItem("DEFAULT_SPACE",b.space);d(b)})}else{return d(b)}}}function notes(a,b,c){return init(a,b,function(i){if(c){c(i)}backstage();window.onbeforeunload=function(){if(!notabene.supports_local_storage()&&m().dirty().length){return["There are unsynced changes. Are you sure you want to leave?\n\n","Please upgrade your browser if possible to make sure you never lose a note."].join("")}};var B=setup_store(i);var m=B.store;var d=B.bag;var w=B.host;var D=m().sort(function(H,G){return H.fields._modified<G.fields._modified?1:-1});var e,k;function h(N){var G={_created:{label:"created on"},_modified:{label:"last modified on"}};$("#notemeta").empty();var H=$('<div class="paddedbox" />').appendTo("#notemeta")[0];var M=$("<ul />").appendTo(H)[0];for(var L in N.fields){if(L.indexOf("_")!==0){var I=N.fields[L];if(I){var O=G[L]?G[L].label:L;$("<li />").text(O+": "+I).appendTo(M)}}}var P=N.tags||[];if(P.length>0){var J=$("<li />").appendTo(M);$("<span />").text("tags : ").appendTo(J);for(var K=0;K<P.length;K++){$("<span />").text(P[K]).appendTo(J);$('<a class="removeTag">remove</a>').data("tag",P[K]).click(function(R){var Q=$(R.target).data("tag");F(Q);y();R.preventDefault()}).appendTo(J)}}}function j(){$(".note_title").val("");$(".note_text").val(e.text);if(e.title!=k&&e.fields._title_set){$(".note_title").val(e.title).focus()}if(e.fields._title_validated){$(".note_title").blur().attr("disabled",true);$(document.body).addClass("validatedNote")}else{$(".note_title").attr("disabled",false);$(document.body).removeClass("validatedNote")}h(e);notabene.watchPosition(function(H){if(e.fields["geo.lat"]&&e.fields["geo.long"]){return}if(H){var G=H.coords;e.fields["geo.lat"]=String(G.latitude);e.fields["geo.long"]=String(G.longitude)}})}function s(){return"untitled note "+Math.random()}function v(){k=s();e=new tiddlyweb.Tiddler(k,d);e.fields={};e.tags=[];e.fields._created=new Date();j()}function C(G,H,J){var I=$(".messageArea",a);I=I.length>0?I:$("<div class='messageArea' />").appendTo(a);I.attr("class","messageArea displayed").html("<div>"+G+"</div>");$(".messageArea div").stop(false,false).show();if(J){$(".messageArea div").css({opacity:1}).fadeOut(5000)}if(H){$(I).addClass(H)}}function r(){var H=$(".syncButton");var G=m().dirty();$(H).text(G.length);renderIncomplete(m,d.name)}function A(G,H){e=new tiddlyweb.Tiddler(G);e.fields={};e.bag=new tiddlyweb.Bag(H||d.name,w);m.get(e,function(I,K,J){var L=J?J.status===404:false;if(I){delete I.fields.created;delete I.fields.modified;e=I}else{if(!L){f()}}if(m().title(e.title).bag(d.name).dirty().length===0){if(I){e.fields._title_validated="yes"}}if(L||I){e.fields._title_set="yes"}$(a).addClass("ready");j()})}function z(){var H=$(".syncButton");H=H.length>0?H:$("<div class='syncButton' />").prependTo(a);r();H.click(function(M){var K,O=0,N=[];var L=m().dirty();C("Syncing to server");var I=function(P){if(P){notabene.addRecentChange(P.bag.name,P.title)}if(O===0){if(L.length>0){C("Finish your note '"+e.title+"' before syncing.","warning")}else{C("Nothing to sync.","warning")}}else{if(N.length>0){C("Sync failed. Please rename some of your notes.","error")}else{if(P&&!K){C("Sync completed.","",true)}else{K=true;C("Unable to fully sync at current time.","warning")}}}r()};var J=$(".note_title").val();L.each(function(P){if(P.title!==J){O+=1;l(P,function(Q,R){if(R){m.save(Q,I)}else{N.push(Q);I(false)}})}else{I(false)}})});function G(){var L=window.location.hash;var K=L.match(/tiddler\/([^\/]+)$/);var M=L.match(/tiddler\/$/);if(K&&K[1]){var I=L.match(/bags\/([^\/]*)\//);var J=I&&decodeURIComponent(I[1])?I[1]:undefined;if(L.indexOf("quickedit/")>-1){$("#newnote,#cancelnote,#deletenote").addClass("quickedit")}A(decodeURIComponent(K[1]),J)}else{if(!M&&D[0]){e=D[0];j();if($(".takenotedashboard").length===0&&firstTime){setTimeout(function(){var N=["We've restored your last incomplete note for you to finish and save. ","<a href='/takenote#tiddler/'>Start a new note</a> if you prefer."].join("");C(N,"",true)},500)}}else{v()}$(a).addClass("ready")}if(i.space){$.ajax({url:"/spaces/"+i.space+"/members",error:function(){$(document.body).addClass("non-member");var N=["You are not a member of this space. ","Any notes you create will not be saved to the server. "].join("");C(N,"error",false)}})}firstTime=false}G();if(window.addEventListener){window.addEventListener("hashchange",G,true)}}function u(H){var G=!H.text?true:false;var I=H.fields&&H.fields._title_set?false:true;return I&&G?true:false}function y(){e.fields._modified=new Date();if(!u(e)){m.add(e)}r()}function p(H){var G=e.title;if(H!==G&&!u(e)){e.title=H;m.add(e);m.remove(new tiddlyweb.Tiddler(G,d))}}function l(G,I){var H=new tiddlyweb.Tiddler(G.title,d);if(RESERVED_TITLES.indexOf(G.title)>-1){I(G,false,true)}else{if(G.fields._title_validated){I(G,true)}else{H.get(function(){I(G,false)},function(J){if(J.status==404){G.fields._title_validated="yes";I(G,true)}else{I(G,null,null,J)}})}}}var n;function t(H,I){I=I||function(){};var G=function(){if(n){C("Note title set.","",true);n=false}$(".note_title").attr("disabled",true)};l(e,function(K,L,J,N){if(L){G()}else{if(L===false){n=true;var M=J?"This name is reserved and cannot be used. Please provide another.":"A note with this name already exists. Please provide another name.";C(M,"error")}}I(L,N)})}$(document).ready(function(){autoResize($("textarea.note_title")[0],{buffer:0,minHeight:60});autoResize($(".note_text")[0],{minHeight:250});$(".note_title").blur(function(G){var I=$(G.target).val();var H=$.trim(I);if(H.length>0){e.fields._title_set="yes";p(H);y()}else{delete e.fields._title_set;p(s())}}).keydown(function(G){if(G.keyCode===13){G.preventDefault()}})});function F(G){var H=e.tags||[];var J=[];for(var I=0;I<H.length;I++){if(H[I]!==G){J.push(H[I])}}e.tags=J;h(e)}function o(G){var H=e.tags||[];G=["excludeLists","excludeSearch","systemConfig","excludeMissing"].indexOf(G)>-1?G:G.toLowerCase();if(H.indexOf(G)===-1){H.push(G)}e.tags=H;h(e)}function g(J){var H=J.text.match(/#([^ \n#]+)/gi);var K=[];for(var I=0;I<H.length;I++){var G=H[I].substr(1);if(K.indexOf(G)===-1){K.push(G)}}return K}function q(){var H=g(e);for(var G=0;G<H.length;G++){o(H[G])}}var E=[];var x=function(G){if(G===8){E.pop()}else{if(G===32||G===13){if(E.length>1){q()}E=[]}else{if(G===35){if(E.length>1){q();E=["#"]}else{E=["#"]}}else{if(E.length>0){E.push(String.fromCharCode(G))}}}}};$(".note_text").keydown(function(G){e.text=$(G.target).val();if(G.keyCode===8){x(G.keyCode)}y()}).keypress(function(G){e.text=$(G.target).val();x(G.keyCode)}).keyup(function(G){e.text=$(G.target).val();y()}).blur(function(G){if(E.length>0){q()}E=[]}).click(function(G){E=[]}).focus(function(G){E=[]});function f(){$("#note").removeClass("active");$(".note_title, .note_text").val("").attr("disabled",false);window.location.hash="";v();r()}$("#newnote").click(function(H){C("Saving note...");var G=$(H.target).hasClass("quickedit");t(e.title,function(I,J){if(I){m.save(e,function(N,L){if(N){notabene.addRecentChange(N.bag.name,e.title);$("#note").addClass("active");var M=encodeURIComponent(e.title);if(G){window.location=document.referrer||"/"+M}else{var K="/bags/"+N.bag.name+"/tiddlers/"+M;var O=$("<div />").append($("<a />").attr("href",K).text(e.title)).html();C("Saved "+O+" successfully.",null,true)}f()}else{if(J&&J.status===403){C("You are not logged into takenote.Please <a href='/challenge'>login</a> to post notes to the web.","warning")}else{C("Saved locally. Unable to post to web at current time.","warning")}f()}})}else{if(I==null){C("Saved locally. Unable to post to web at current time.","warning");f()}}})});$("#deletenote").click(function(I){var H=confirm("Delete this note?");if(!H){return}C("Deleting note...");if(e){var G=e.fields._title_validated?true:false;m.destroy(e,function(J,L,K){r();if(K&&K.status===0){C("Could not delete from server at current time.","warning",true);y();f()}else{if(J){$("#note").addClass("deleting");C("Note deleted.",null,true);$("#note").removeClass("deleting");$(".note_title, .note_text").val("").attr("disabled",false);f()}else{C("Error deleting note. Please try again.","error")}}})}});$("#cancelnote").click(function(I){var H=confirm("Cancel editing this note and revert to previous online version?");if(H){var G=$(I.target).hasClass("quickedit");m.remove(e.title);f();if(G){window.location=document.referrer||"/"+encodeURIComponent(e.title)}}});z();return{init:z,resetNote:f,findTags:g,tagHandler:x,printMessage:C,newNote:v,loadNote:j,addTag:o,removeTag:F,store:m,printMetaData:h,validateCurrentNoteTitle:t,getNote:function(){return e},tempTitle:k,loadServerNote:A}})}function backstage(){var a,d,c;function b(){if(d){return}else{d=true;$.ajax({url:"/status",success:function(e){a=true;d=false;$("body").addClass("online");if(!c){c=true}},error:function(){a=false;d=false;$("body").removeClass("online")}})}}b();window.setInterval(b,60000)}function renderIncomplete(a,g){var e=a().dirty().sort(function(i,h){return i.title<h.title?-1:1});var c=$("#incomplete").empty()[0];if(c){for(var b=0;b<e.length;b++){var d=$("<li />").appendTo(c)[0];var f=e[b].title;$("<a />").attr("href",APP_PATH+"#!/tiddler/"+f).text(f).appendTo(d)}if(e.length===0){$("<li />").text("None.").appendTo(c)[0]}}}function dashboard(a,c){var e=$("#recentnotes");if(e.length>0){var d=notabene.getRecentChanges();function b(k){$(e).empty();if(k.length===0){$("<li />").text("No recently created notes.").appendTo(e)[0]}for(var h=0;h<k.length;h++){var g=$("<li />").appendTo(e)[0];var l=k[h];if(typeof(l)==="string"){l={title:l}}var j=l.bag||c.bag;$("<a />").attr("href","/bags/"+j+"/tiddlers/"+encodeURIComponent(l.title)).text(l.title).appendTo(g)}}function f(){$.ajax({url:"/tiddlers?select=tag:!excludeLists&sort=-created&limit=5",dataType:"json",success:function(j){notabene.clearRecentChanges();for(var h=j.length-1;h>-1;h--){var g=j[h];notabene.addRecentChange(g.bag,g.title)}d=notabene.getRecentChanges();b(d.reverse())}})}f();b(d.reverse())}return notes(a,c,function(i){if(i.space){var l=i.space+"_private";$('<li><a href="/takenote#tiddler/New%20Public%20Note" class="button">take public note</a></li>').appendTo("#createNotes");$('<li><a href="/takenote#/bags/'+l+'/tiddler/New%20Private%20Note" class="button">take private note</a></li>').appendTo("#createNotes")}var n=500;var m=window.setInterval(function(){var o=$(".searching");if(o.length>0){var p=o.css("opacity");p=p?parseFloat(p,10):1;if(p>0.7){o.animate({opacity:0.6},n)}else{o.animate({opacity:1},n)}}},n);var k={},j=[];$.ajax({dataType:"text",url:"/bags/"+i.bag+"/tiddlers?select=tag:!excludeLists",success:function(o){j=o.split("\n")}});function h(r,o){r=r.toLowerCase();var q=[];for(var p=0;p<j.length;p++){var s=j[p];if(s.toLowerCase().indexOf(r)>-1&&o.indexOf(s)===-1){q.push({value:s,label:s,bag:i.bag})}}return q}$(".findnote").autocomplete({source:function(r,o){var q=$(this.element);q.addClass("searching");var p=r.term;if(k[p]){return o(k[p])}o(h(p,[]));$.ajax({url:"/search?q=bag:"+i.bag+' "'+p+' "&select=tag:!excludeLists',dataType:"json",success:function(t){q.removeClass("searching").css({opacity:1});var w=[];var v=h(p,v);for(var x=0;x<t.length;x++){var A=t[x];var u=A.bag;var s=u.split("_");var B=s[0];var y=s[1];var z=A.type;v.push(A.title);if(!z){w.push({value:A.title,label:A.title,bag:A.bag})}}if(w.length===0){w.push({label:"No notes found"})}k[p]=w;o(w)},error:function(){var s=[];s.concat(h(p,[]));if(s.length===0){s.push({label:"Unable to search at current time"})}q.removeClass("searching").css({opacity:1});o(s)}})},select:function(o,p){if(p.item.value&&p.item.bag){window.location="/bags/"+p.item.bag+"/tiddlers/"+encodeURIComponent(p.item.value)}}});var g=setup_store(i);renderIncomplete(g.store,g.bag.name)})}window.addEventListener("load",function(){window.setTimeout(function(){var a=new google.bookmarkbubble.Bubble();var b="bubble";a.setHashParameter=function(){localStorage.setItem(b,"yes")};a.hasHashParameter=function(){return localStorage.getItem(b)?true:false};a.getViewportHeight=function(){return window.innerHeight};a.getViewportScrollY=function(){return window.pageYOffset};a.registerScrollHandler=function(c){window.addEventListener("scroll",c,false)};a.deregisterScrollHandler=function(c){window.removeEventListener("scroll",c,false)};a.showIfAllowed()},1000)},false);addEventListener("load",function(){setTimeout(hideURLbar,0)},false);function hideURLbar(){window.scrollTo(0,1)};